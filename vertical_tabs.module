<?php

/**
 * @file Main file for the vertical tabs module - provides vertical tabs on the
 * node form.
 */

/**
 * Implementation of hook_form_alter.
 */
function vertical_tabs_form_alter(&$form, $form_state, $form_id) {
  $fieldsets = array();
  $node_form = FALSE;
  // Check to see which form we are in. Since the node form's form id is not
  // just node_form, we can't implement a function for all node forms, so we are
  // stuck implementing the global form_alter and checking if there is the
  // string node_form in the form id.
  if (strpos($form_id, 'node_form')) {
    // The $fieldsets array is a list of all supported fieldsets in core
    // for the node form, and their JavaScript summary creators.
    $fieldsets = array(
      'book' => 'book',
      'revision_information' => 'revision',
      'author' => 'authoring',
      'options' => 'publishingOptions',
      'menu' => 'menu',
      'comment_settings' => 'comment',
      'path' => 'path',
      'attachments' => 'attachments',
    );
    $node_form = TRUE;
  }
  if ($node_form) {
    // The javascript to add to the page.
    $javascript = array();
    // Iterate through the form, finding fieldsets.
    foreach (element_children($form) as $key) {
      // We need to make sure that the element we have is a fieldset
      // and the user has access to this field.
      if (isset($form[$key]['#type']) && $form[$key]['#type'] == 'fieldset' &&
        (!isset($form[$key]['#access']) || $form[$key]['#access'] != FALSE)) {
        // Add the JavaScript.
        $javascript[$key] = array('name' => $form[$key]['#title']);
        // If there's a summary callback, then add it.
        if (isset($form[$key]['#summary_callback']) || isset($fieldsets[$key])) {
          $javascript[$key]['callback'] = (isset($form[$key]['#summary_callback']) ? $form[$key]['#summary_callback'] : $fieldsets[$key]);
          $javascript[$key]['args'] = (isset($form[$key]['#summary_arguments']) ? $form[$key]['#summary_arguments'] : array());
        }
        // Add a class to identify the fieldset.
        if (isset($form[$key]['#attributes']['class']) && !empty($form[$key]['#attributes']['class'])) {
          $form[$key]['#attributes']['class'] .= ' vertical-tabs-fieldset vertical-tabs-'. $key;
        }
        else {
          $form[$key]['#attributes']['class'] = 'vertical-tabs-fieldset vertical-tabs-'. $key;
        }
      }
    }
    // A <div> for easier placement of the tab element.
    $form['buttons']['#prefix'] = '<div class="buttons">';
    $form['buttons']['#suffix'] = '</div>';
    // Add the JavaScript.
    drupal_add_js(array('verticalTabs' => $javascript), 'setting');
    // Indicate that the JavaScript should be added later. We do this so that
    // our JavaScript gets added after collapse.js.
    $form['#post_render'][] = 'vertical_tabs_add_js_css';
    $form['#post_render'][] = 'vertical_tabs_add_node_form_js';
  }
}

/**
 * Add the JavaScript and CSS.
 */
function vertical_tabs_add_js_css($form) {
  drupal_add_js(drupal_get_path('module', 'vertical_tabs') .'/vertical_tabs.js');
  drupal_add_css(drupal_get_path('module', 'vertical_tabs') .'/vertical_tabs.css');
  return $form;
}

/**
 * Add the JavaScript for the node form.
 */
function vertical_tabs_add_node_form_js($form) {
  drupal_add_js(drupal_get_path('module', 'vertical_tabs') .'/vertical_tabs.node_form.js');
  return $form;
}

/**
 * Add the JavaScript for the settings form.
 */
function vertical_tabs_add_settings_js($form) {
  drupal_add_js(drupal_get_path('module', 'vertical_tabs') .'/vertical_tabs.settings.js');
  return $form;
}
